# 2025-11-14 개선형 프로파일 트러블슈팅 기록

## 1. 배경
- PUBC 개선형(@Profile("improved")) 컨트롤러가 배포 후 `No service was found` 를 반환하며 CXF 서비스가 노출되지 않음.
- 이후 JSON 직렬화 오류(`No message body writer has been found for class java.util.HashMap`)까지 발생하여 응답 생성이 불가한 상태.

## 2. 주요 이슈와 원인
| 이슈 | 원인 | 영향 |
| --- | --- | --- |
| CXF 엔드포인트 미노출 | Spring profile이 ApplicationContext에 적용되지 않아 `CultureFacilityImprovedRestController` 빈이 생성되지 않음. `CxfConfig` Java Config도 로딩되지 않아 `JAXRSServerFactoryBean` 미생성. | `/api/facilities` 404 (`No service was found`). |
| 프로파일 수동 설정 불가 | `application.properties`의 `spring.profiles.active` 값이 Spring MVC 부트스트랩 단계에서 무시됨. | 프로파일 전환 시 web.xml 수정이 필요 → 실수 가능성 높음. |
| JSON Writer 미등록 | CXF JAX-RS에 Jackson Provider 미연결. | 응답 생성 시 500 Internal Server Error. |
| Bean 순환 의존 | Jackson Provider를 `@Autowired` 필드로 주입하면서 `CxfConfig`와 상호 참조. | 배포 실패, Undertow 시작 불가. |

## 3. 조치 사항
1. `ProfileInitializer` 추가
   - `ApplicationContextInitializer` 구현으로 `config/application.properties`에서 `spring.profiles.active`를 읽어 Spring Environment에 적용.
   - `web.xml`에 `contextInitializerClasses`로 등록하여 부트스트랩 단계에서 항상 프로파일이 세팅되도록 함.
2. `root-context.xml`에 `CxfConfig` 명시 등록
   - CXF Java Config가 실제 빈으로 로딩되어 프로파일별 서버를 생성.
3. `CxfConfig` 개선
   - Bean 반환 타입을 `Server`로 변경하고, 초기화 로그 표시.
   - Jackson Provider Bean (`JacksonJaxbJsonProvider`) 생성 및 `factory.setProviders(...)`로 연결.
   - Provider는 `@Bean` 메서드를 직접 호출하여 순환 참조 제거.
4. `pom.xml`에 `jackson-jaxrs-json-provider` 의존성 추가
   - CXF가 JSON 응답을 직렬화할 수 있도록 Provider 클래스 포함.
5. 검증
   - `mvn clean package` → WAR 재배포 → WildFly 재기동.
   - `curl -i "http://localhost:8080/pubc-test-api/api/facilities?serviceKey=TEST_KEY_001"` 호출 결과 200 OK 및 JSON 응답 확인.

## 4. 향후 개발자를 위한 체크리스트
1. **프로파일 관리**
   - 기본값은 `config/application.properties`의 `spring.profiles.active`. 서버 기동 시 `-Dspring.profiles.active=mock` 등으로 재정의 가능.
   - 새 프로파일을 만들 경우 `ProfileInitializer`에서 값을 읽을 수 있도록 동일 파일에 키를 추가하거나 시스템 프로퍼티를 이용할 것.
2. **CXF 컨트롤러 추가 시**
   - `@Path` 기반 JAX-RS 컨트롤러에 `@Profile`을 적용한 경우, `CxfConfig`에서 해당 Bean을 주입받는 별도 `@Bean` 메서드를 추가해야 한다.
   - Provider(직렬화기) 의존성도 `setProviders`에 명시적으로 등록할 것.
3. **JSON 직렬화**
   - Map/VO 응답을 반환하면 `jackson-jaxrs-json-provider`가 처리한다. 추가 커스텀이 필요하면 `CxfConfig.jacksonJaxbJsonProvider()`에서 `ObjectMapper` 설정을 수정한다.
4. **배포 전 검증 순서**
   - `mvn clean package`
   - WildFly `standalone/deployments`에 WAR 덮어쓰기
   - `bin/jboss-start.sh` 백그라운드 실행 후 로그(`logs/jboss-standalone.log`)에서 `[ProfileInitializer]`, `[CXF]` 메시지 확인
   - `curl` 로 API Smoke Test 진행
5. **문제 발생 시 빠른 점검 포인트**
   - `logs/jboss-standalone.log`에서 `[ProfileInitializer]`, `[CXF] Registered JAX-RS service` 로그가 보이는지 확인.
   - 404: 컨트롤러 빈/프로파일, CXF Factory 생성 여부 확인.
   - 500(JSON): Jackson Provider 의존성 및 `setProviders` 설정 확인.

## 5. 참고 커밋/파일
- `src/main/java/iros/api/common/config/ProfileInitializer.java`
- `src/main/java/iros/api/common/config/CxfConfig.java`
- `src/main/webapp/WEB-INF/web.xml`
- `src/main/resources/config/spring/root-context.xml`
- `pom.xml`
